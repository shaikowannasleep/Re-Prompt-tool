<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Canvas Prompt Architect v5.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-dark: #0f172a;
            --panel-bg: rgba(30, 41, 59, 0.7);
            --border-color: rgba(255, 255, 255, 0.08);
            --primary: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #e2e8f0;
            overflow: hidden;
        }

        .font-code { font-family: 'JetBrains Mono', monospace; }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Animations */
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
        .btn-hover:hover { transform: translateY(-1px); box-shadow: 0 8px 16px -4px rgba(59, 130, 246, 0.2); }

        /* Quick Select Chips */
        .fav-chip {
            font-size: 0.75rem; padding: 0.4rem 0.8rem; border-radius: 8px; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; background: rgba(15, 23, 42, 0.6); color: #94a3b8;
            display: flex; align-items: center; gap: 6px; font-weight: 500;
        }
        .fav-chip:hover { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); color: #cbd5e1; }
        .fav-chip.active { background: rgba(37, 99, 235, 0.2); border-color: #3b82f6; color: #fff; }
        .fav-chip i { color: #fbbf24; font-size: 0.7rem; } 

        .all-chip { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2); color: #34d399; }
        .all-chip:hover { background: rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.4); }

        /* MEGA MODAL */
        #mega-modal {
            position: fixed; inset: 0; z-index: 50;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        #mega-modal.open { opacity: 1; pointer-events: auto; }
        
        .role-grid-card {
            position: relative;
            background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255,255,255,0.05);
            padding: 10px; border-radius: 6px; cursor: pointer; transition: all 0.15s;
        }
        .role-grid-card:hover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); transform: translateY(-1px); }
        .role-grid-card h4 { font-weight: 600; color: #f1f5f9; font-size: 0.85rem; padding-right: 20px; }
        .role-grid-card p { font-size: 0.7rem; color: #64748b; margin-top: 2px; }

        /* Star Button in Card */
        .card-star-btn {
            position: absolute; top: 8px; right: 8px;
            width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            color: #475569; transition: all 0.2s;
            z-index: 10;
        }
        .card-star-btn:hover { background: rgba(255,255,255,0.1); color: #fbbf24; }
        .card-star-btn.is-fav { color: #fbbf24; }
        .card-star-btn i { font-size: 0.8rem; }

        /* TOOLTIP SYSTEM */
        #tooltip-portal { 
            position: fixed; z-index: 9999; pointer-events: none; opacity: 0; 
            transition: opacity 0.15s, transform 0.15s; transform: translateY(4px); max-width: 320px; 
        }
        .tooltip-content { 
            background: rgba(15, 23, 42, 0.98); border: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 12px; border-radius: 8px; font-size: 0.8rem; color: #e2e8f0; 
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.8);
            line-height: 1.5;
        }
        .tooltip-header {
            color: #60a5fa; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; 
            margin-bottom: 4px; display: flex; align-items: center; gap: 6px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px;
        }
        .has-hint { cursor: help; border-bottom: 1px dashed rgba(148, 163, 184, 0.4); }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center p-4 lg:p-8 bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">

    <!-- MEGA MODAL -->
    <div id="mega-modal">
        <div class="bg-[#0f172a] w-[95%] max-w-6xl h-[90vh] rounded-xl border border-slate-700 shadow-2xl flex flex-col overflow-hidden transform scale-100 transition-transform duration-200">
            <!-- Modal Header -->
            <div class="p-4 border-b border-slate-800 bg-slate-900 flex flex-col gap-4">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-lg font-bold text-white flex items-center gap-2 has-hint" data-tooltip="lib_title">
                            <i class="fa-solid fa-address-book text-blue-500"></i> Persona Library
                        </h2>
                        <p class="text-xs text-slate-500">Search and manage your favorite AI roles.</p>
                    </div>
                    <button id="closeMega" class="w-8 h-8 rounded hover:bg-slate-800 text-slate-400 hover:text-white transition"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <!-- Search Bar -->
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-500 text-xs"></i>
                    <input type="text" id="megaSearch" 
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg py-2.5 pl-9 pr-4 text-sm text-slate-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none placeholder-slate-600 has-hint"
                        data-tooltip="lib_search"
                        placeholder="Search roles (e.g., 'Unity', 'Security', 'Frontend')...">
                </div>
            </div>

            <!-- Modal Body (Grid) -->
            <div class="flex-grow overflow-y-auto p-6 custom-scrollbar bg-[#0b1120]">
                <div id="mega-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- TOOLTIP PORTAL -->
    <div id="tooltip-portal"><div class="tooltip-content"></div></div>

    <div class="w-full max-w-7xl h-[92vh] grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- LEFT PANEL: CONFIGURATION -->
        <div class="col-span-1 lg:col-span-4 glass-panel rounded-2xl p-6 flex flex-col h-full relative overflow-hidden">
            <header class="mb-5 flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-white shadow-lg">
                    <i class="fa-solid fa-microchip"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white tracking-tight has-hint" data-tooltip="app_title">Prompt Architect</h1>
                    <p class="text-[10px] text-slate-400 font-mono">v5.2 | Anti-Lazy Code</p>
                </div>
            </header>

            <form id="inputForm" class="flex-grow flex flex-col gap-5 z-10">
                
                <!-- PERSONA SELECTOR -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider has-hint" data-tooltip="target_persona">Target Persona</label>
                    </div>
                    
                    <!-- Quick Select -->
                    <div class="flex flex-wrap gap-2" id="quickSelectBar">
                        <!-- Favs injected here -->
                        <button type="button" id="btnOpenAll" class="fav-chip all-chip has-hint" data-tooltip="all_targets">
                            <i class="fa-solid fa-grid-2"></i> All Targets
                        </button>
                    </div>

                    <!-- Dropdown -->
                    <div class="relative group">
                        <select id="roleSelect" class="w-full bg-slate-800/80 border border-slate-700 rounded-lg py-3 pl-3 pr-8 text-xs text-slate-200 focus:ring-1 focus:ring-blue-500 outline-none cursor-pointer hover:bg-slate-800 transition font-mono">
                            <!-- Options injected -->
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-xs text-slate-500 pointer-events-none"></i>
                    </div>

                    <!-- Dynamic Info Box -->
                    <div id="personaInfoBox" class="bg-slate-900/50 border-l-2 border-blue-500 p-3 rounded-r text-xs text-slate-400 hidden">
                        <p id="infoDesc" class="mb-1 leading-relaxed">...</p>
                        <div class="flex gap-2 mt-2">
                            <span class="px-1.5 py-0.5 bg-blue-500/10 text-blue-400 rounded text-[10px]">Expertise: <b id="infoExpertise">...</b></span>
                        </div>
                    </div>
                </div>

                <!-- INPUT AREA -->
                <div class="space-y-2 flex-grow flex flex-col">
                    <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider has-hint" data-tooltip="raw_input">Requirements (Vietnamese)</label>
                    <textarea id="userInput" class="w-full flex-grow bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-sm text-slate-200 focus:ring-1 focus:ring-blue-500 outline-none resize-none font-code leading-relaxed placeholder-slate-600 transition focus:bg-slate-900" 
                    placeholder="Mô tả tính năng bạn muốn làm..."></textarea>
                </div>
            </form>

            <div class="mt-4 z-10">
                <button id="btnAnalyze" class="w-full btn-hover bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3.5 px-4 rounded-xl flex items-center justify-center gap-2 transition-all has-hint" data-tooltip="btn_analyze">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                    <span>Generate & Translate</span>
                </button>
            </div>
            
            <!-- Decor -->
            <div class="absolute -bottom-20 -right-20 w-64 h-64 bg-blue-600/20 rounded-full blur-[100px] pointer-events-none"></div>
        </div>

        <!-- RIGHT PANEL: CONTEXTUAL OUTPUT -->
        <div class="col-span-1 lg:col-span-8 h-full relative">
            
            <!-- IDLE VIEW -->
            <div id="viewIdle" class="absolute inset-0 flex flex-col items-center justify-center glass-panel rounded-2xl border-dashed border-2 border-slate-700/50 p-8 text-center">
                <div class="w-16 h-16 rounded-2xl bg-slate-800 flex items-center justify-center mb-4">
                    <i class="fa-solid fa-layer-group text-3xl text-slate-600"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-300">Context-Aware Generation</h3>
                <p class="text-slate-500 text-sm mt-2 max-w-md">
                    Select a persona and describe your task. <br>
                    Add favorites in the <b>Library</b> for quick access.
                </p>
            </div>

            <!-- STRATEGY VIEW -->
            <div id="viewStrategy" class="hidden absolute inset-0 glass-panel rounded-2xl p-8 flex flex-col fade-enter-active">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-chess-knight text-emerald-400"></i> Dynamic Strategy
                        </h2>
                        <p class="text-slate-400 text-xs mt-1">
                            Strategies tailored for: <span id="strategyRoleLabel" class="text-blue-400 font-mono">...</span>
                        </p>
                    </div>
                    <button id="btnBack" class="text-slate-500 hover:text-white transition"><i class="fa-solid fa-arrow-left"></i> Back</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-grow content-start" id="strategyContainer">
                    <!-- Dynamic Strategies -->
                </div>
            </div>

            <!-- RESULT VIEW -->
            <div id="viewResult" class="hidden absolute inset-0 glass-panel rounded-2xl flex flex-col fade-enter-active overflow-hidden">
                <div class="bg-slate-900/80 border-b border-slate-700 p-4 flex justify-between items-center backdrop-blur">
                    <div class="flex items-center gap-3">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span class="text-xs font-mono text-emerald-400">final_prompt.md</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="btnCopy" class="px-3 py-1.5 rounded text-xs font-medium bg-blue-600 hover:bg-blue-500 text-white transition flex items-center gap-2">
                            <i class="fa-regular fa-copy"></i> Copy Prompt
                        </button>
                    </div>
                </div>
                <div class="relative flex-grow bg-[#0b1120]">
                    <textarea id="outputArea" readonly class="w-full h-full bg-transparent p-6 text-xs font-code text-slate-300 resize-none outline-none leading-relaxed custom-scrollbar"></textarea>
                </div>
            </div>

        </div>
    </div>

    <!-- LOGIC -->
    <script>
        /** --- 1. MASSIVE DATA LAYER (Mutable State) --- **/
        const ROLES = [
            // CORE
            { id: 'expert', cat: 'Core', lbl: 'Senior Software Engineer', vi: 'Kỹ sư phần mềm cao cấp', desc: 'Generalist expert. Clean code & patterns.', fav: true },
            { id: 'architect', cat: 'Core', lbl: 'System Architect', vi: 'Kiến trúc sư hệ thống', desc: 'Focus on scalability, microservices, and high-level design.', fav: true },
            { id: 'algo', cat: 'Core', lbl: 'Algorithm Specialist', vi: 'Chuyên gia Thuật toán', desc: 'Optimization, Big O, Data Structures.', fav: false },

            // GAME DEV
            { id: 'unity_gp', cat: 'Game Dev', lbl: 'Unity Gameplay', vi: 'Lập trình Gameplay Unity', desc: 'C#, Monobehaviour, Game Loop logic.', fav: true },
            { id: 'unity_dots', cat: 'Game Dev', lbl: 'Unity DOTS/Performance', vi: 'Tối ưu hiệu năng Unity', desc: 'ECS, Jobs System, Memory management.', fav: false },
            { id: 'unity_shader', cat: 'Game Dev', lbl: 'Tech Artist (Shader)', vi: 'Kỹ thuật Shader/VFX', desc: 'HLSL, Shader Graph, GPU optimization.', fav: false },
            { id: 'unreal_cpp', cat: 'Game Dev', lbl: 'Unreal C++ Engineer', vi: 'Kỹ sư Unreal C++', desc: 'UE5, Blueprints to C++, Networking.', fav: false },
            { id: 'godot', cat: 'Game Dev', lbl: 'Godot Developer', vi: 'Lập trình viên Godot', desc: 'GDScript, 2D/3D indie development.', fav: false },

            // WEB
            { id: 'fe_react', cat: 'Web', lbl: 'React Specialist', vi: 'Chuyên gia ReactJS', desc: 'Hooks, State Management, Next.js.', fav: false },
            { id: 'be_node', cat: 'Web', lbl: 'Node.js Backend', vi: 'Backend Node.js', desc: 'Express/NestJS, Microservices, MongoDB.', fav: false },
            { id: 'be_go', cat: 'Web', lbl: 'Golang Engineer', vi: 'Kỹ sư Golang', desc: 'Concurrency, High throughput systems.', fav: false },
            { id: 'fullstack', cat: 'Web', lbl: 'Fullstack Developer', vi: 'Lập trình Fullstack', desc: 'End-to-end web development.', fav: false },

            // DATA & AI
            { id: 'ai_ml', cat: 'Data', lbl: 'AI/ML Engineer', vi: 'Kỹ sư AI/Machine Learning', desc: 'Python, PyTorch, Model integration.', fav: false },
            { id: 'data_eng', cat: 'Data', lbl: 'Data Engineer', vi: 'Kỹ sư dữ liệu', desc: 'ETL Pipelines, Big Data, SQL optimization.', fav: false },

            // INFRA & SEC
            { id: 'devops', cat: 'Infra', lbl: 'DevOps Engineer', vi: 'Kỹ sư DevOps', desc: 'CI/CD, Docker, Kubernetes, AWS.', fav: false },
            { id: 'security', cat: 'Infra', lbl: 'Security Researcher', vi: 'Chuyên gia bảo mật', desc: 'Penetration testing, OWASP, Auditing.', fav: false },
            { id: 'sre', cat: 'Infra', lbl: 'Site Reliability Eng', vi: 'Kỹ sư vận hành (SRE)', desc: 'Uptime, Monitoring, Incident response.', fav: false },

            // MOBILE & EMBEDDED
            { id: 'ios', cat: 'Mobile', lbl: 'iOS Engineer', vi: 'Lập trình iOS (Swift)', desc: 'SwiftUI, UIKit, Apple Ecosystem.', fav: false },
            { id: 'android', cat: 'Mobile', lbl: 'Android Engineer', vi: 'Lập trình Android (Kotlin)', desc: 'Kotlin, Jetpack Compose.', fav: false },
            { id: 'flutter', cat: 'Mobile', lbl: 'Flutter Developer', vi: 'Lập trình Flutter', desc: 'Cross-platform mobile apps.', fav: false },
            { id: 'embedded', cat: 'Embedded', lbl: 'Embedded Systems Eng', vi: 'Kỹ sư nhúng', desc: 'C/C++, Firmware, Hardware interface.', fav: false }
        ];

        const TOOLTIPS_VI = {
            'app_title': 'Công cụ tạo Prompt chuyên nghiệp cho AI Code.',
            'target_persona': 'Vai trò AI: Chọn đúng vai trò sẽ giúp AI dùng đúng từ vựng chuyên ngành.',
            'all_targets': 'Mở thư viện toàn bộ các vai trò. Có thể tìm kiếm và đánh dấu yêu thích.',
            'raw_input': 'Nhập yêu cầu của bạn bằng tiếng Việt tự nhiên. Hệ thống sẽ tự dịch.',
            'btn_analyze': 'Phân tích yêu cầu và đề xuất chiến lược phù hợp nhất với vai trò đã chọn.',
            'lib_title': 'Thư viện Vai trò. Nơi bạn tìm kiếm và quản lý danh sách yêu thích.',
            'lib_search': 'Nhập từ khóa để lọc danh sách. Ví dụ: "Web", "Game", "Unity"...'
        };

        /** --- 2. DYNAMIC STRATEGY ENGINE --- **/
        function getStrategiesForRole(roleId) {
            const role = ROLES.find(r => r.id === roleId);
            const cat = role ? role.cat : 'Core';
            const strategies = [];

            strategies.push({
                title: "Implementation Focus",
                icon: "fa-code",
                desc: "Code chính xác, chạy được ngay. Tối ưu cho task cụ thể.",
                promptMod: "Focus strictly on implementation details, clean syntax, and functional correctness."
            });

            if (cat === 'Game Dev') {
                strategies.push({
                    title: "Performance & Optimization",
                    icon: "fa-gauge-high",
                    desc: "Tối ưu FPS, Memory, Garbage Collection (Quan trọng cho Game).",
                    promptMod: "Prioritize performance, memory management, and frame-rate optimization. Use object pooling and avoid garbage collection spikes."
                });
                strategies.push({
                    title: "Scalable Game Architecture",
                    icon: "fa-cubes-stacked",
                    desc: "Thiết kế hệ thống Module, dễ mở rộng DLC/Feature.",
                    promptMod: "Design a modular architecture suitable for game development (e.g., Component patterns, ScriptableObjects)."
                });
            } else if (cat === 'Infra' || roleId === 'security') {
                strategies.push({
                    title: "Zero-Trust Security",
                    icon: "fa-shield-virus",
                    desc: "Bảo mật tuyệt đối, Valid input, chống Injection.",
                    promptMod: "Adopt a Zero-Trust security model. Validate all inputs, sanitize data, and follow OWASP best practices."
                });
            } else if (cat === 'Web') {
                strategies.push({
                    title: "Scalable Microservices",
                    icon: "fa-network-wired",
                    desc: "Thiết kế tách biệt, API Gateway, Database Sharding.",
                    promptMod: "Design for horizontal scalability. Consider microservices boundaries, API versioning, and database consistency."
                });
            } else {
                strategies.push({
                    title: "Design Patterns & Arch",
                    icon: "fa-sitemap",
                    desc: "Áp dụng mẫu thiết kế chuẩn (Factory, Observer...).",
                    promptMod: "Apply appropriate GoF Design Patterns. Ensure the code is loosely coupled and highly cohesive."
                });
            }

            strategies.push({
                title: "Defensive Programming",
                icon: "fa-bug-slash",
                desc: "Xử lý mọi lỗi có thể xảy ra (Edge-cases).",
                promptMod: "Focus on error handling, logging, and graceful degradation. Cover edge cases."
            });

            return strategies.slice(0, 3);
        }

        /** --- 3. CONTROLLER --- **/
        const App = {
            state: { roleId: 'expert', input: '', filter: '' },

            init() {
                this.dom = {
                    roleSelect: document.getElementById('roleSelect'),
                    quickSelect: document.getElementById('quickSelectBar'),
                    infoBox: document.getElementById('personaInfoBox'),
                    infoDesc: document.getElementById('infoDesc'),
                    infoExp: document.getElementById('infoExpertise'),
                    megaModal: document.getElementById('mega-modal'),
                    megaGrid: document.getElementById('mega-grid'),
                    megaSearch: document.getElementById('megaSearch'),
                    views: {
                        idle: document.getElementById('viewIdle'),
                        strategy: document.getElementById('viewStrategy'),
                        result: document.getElementById('viewResult')
                    },
                    stratContainer: document.getElementById('strategyContainer'),
                    output: document.getElementById('outputArea'),
                    input: document.getElementById('userInput'),
                    tooltip: {
                        el: document.getElementById('tooltip-portal'),
                        content: document.querySelector('.tooltip-content')
                    }
                };

                this.renderUI();
                this.bindEvents();
                this.setRole('expert');
            },

            renderUI() {
                this.renderDropdown();
                this.renderQuickSelect();
                this.renderMegaGrid();
            },

            renderDropdown() {
                this.dom.roleSelect.innerHTML = ROLES.map(r => 
                    `<option value="${r.id}">${r.lbl}</option>`
                ).join('');
            },

            renderQuickSelect() {
                const favorites = ROLES.filter(r => r.fav);
                const allBtn = document.getElementById('btnOpenAll');
                
                // Clear old favs
                Array.from(this.dom.quickSelect.children).forEach(child => {
                    if (child.id !== 'btnOpenAll') child.remove();
                });

                favorites.forEach(r => {
                    const btn = document.createElement('button');
                    btn.className = `fav-chip ${r.id === this.state.roleId ? 'active' : ''}`;
                    btn.innerHTML = `<i class="fa-solid fa-star"></i> ${r.lbl}`;
                    btn.onclick = () => this.setRole(r.id);
                    btn.dataset.role = r.id; 
                    this.dom.quickSelect.insertBefore(btn, allBtn);
                });
            },

            renderMegaGrid() {
                const filter = this.state.filter.toLowerCase();
                const filteredRoles = ROLES.filter(r => 
                    r.lbl.toLowerCase().includes(filter) || 
                    r.vi.toLowerCase().includes(filter) || 
                    r.desc.toLowerCase().includes(filter)
                );

                const groups = {};
                filteredRoles.forEach(r => {
                    if(!groups[r.cat]) groups[r.cat] = [];
                    groups[r.cat].push(r);
                });

                let gridHtml = '';
                if (filteredRoles.length === 0) {
                    gridHtml = `<div class="col-span-full text-center text-slate-500 mt-10">No roles found matching "${this.state.filter}"</div>`;
                } else {
                    for(const [cat, list] of Object.entries(groups)) {
                        gridHtml += `<div class="col-span-full mt-2 mb-1 text-[10px] font-bold text-slate-500 uppercase tracking-widest border-b border-slate-800 pb-1">${cat}</div>`;
                        list.forEach(r => {
                            gridHtml += `
                                <div class="role-grid-card" onclick="App.setRole('${r.id}'); App.toggleMega(false)">
                                    <div class="card-star-btn ${r.fav ? 'is-fav' : ''}" onclick="App.toggleFavorite('${r.id}', event)">
                                        <i class="fa-${r.fav ? 'solid' : 'regular'} fa-star"></i>
                                    </div>
                                    <h4>${r.lbl}</h4>
                                    <p>${r.vi}</p>
                                </div>
                            `;
                        });
                    }
                }
                this.dom.megaGrid.innerHTML = gridHtml;
            },

            bindEvents() {
                this.dom.roleSelect.addEventListener('change', (e) => this.setRole(e.target.value));
                document.getElementById('btnOpenAll').addEventListener('click', () => {
                    this.state.filter = ''; // Reset filter on open
                    this.dom.megaSearch.value = '';
                    this.renderMegaGrid();
                    this.toggleMega(true);
                    setTimeout(() => this.dom.megaSearch.focus(), 100);
                });
                document.getElementById('closeMega').addEventListener('click', () => this.toggleMega(false));
                this.dom.megaModal.addEventListener('click', (e) => {
                    if(e.target === this.dom.megaModal) this.toggleMega(false);
                });

                // Search Listener
                this.dom.megaSearch.addEventListener('keyup', (e) => {
                    this.state.filter = e.target.value;
                    this.renderMegaGrid();
                });

                document.getElementById('btnAnalyze').addEventListener('click', () => this.analyze());
                document.getElementById('btnBack').addEventListener('click', () => this.switchView('idle'));
                document.getElementById('btnCopy').addEventListener('click', () => {
                    this.dom.output.select();
                    document.execCommand('copy');
                    alert('Copied to clipboard!');
                });

                // Global Tooltip Delegation (Covers new elements)
                document.body.addEventListener('mouseover', (e) => {
                    const target = e.target.closest('[data-tooltip]');
                    if (target) this.showTooltip(target, target.dataset.tooltip);
                });
                document.body.addEventListener('mouseout', (e) => {
                    if (e.target.closest('[data-tooltip]')) this.hideTooltip();
                });
            },

            toggleFavorite(id, event) {
                event.stopPropagation(); // Prevent selecting the role when clicking star
                const role = ROLES.find(r => r.id === id);
                if (role) {
                    role.fav = !role.fav;
                    this.renderMegaGrid(); // Update star icon state
                    this.renderQuickSelect(); // Update top bar chips
                }
            },

            setRole(id) {
                this.state.roleId = id;
                this.dom.roleSelect.value = id;
                
                // Update Quick Select Active State
                Array.from(this.dom.quickSelect.children).forEach(btn => {
                    if (btn.dataset.role === id) btn.classList.add('active');
                    else btn.classList.remove('active');
                });

                // Update Info Box
                const role = ROLES.find(r => r.id === id);
                if (role) {
                    this.dom.infoBox.classList.remove('hidden');
                    this.dom.infoDesc.textContent = role.desc;
                    this.dom.infoExp.textContent = role.cat;
                }
            },

            toggleMega(show) {
                if(show) this.dom.megaModal.classList.add('open');
                else this.dom.megaModal.classList.remove('open');
            },

            showTooltip(el, key) {
                const text = TOOLTIPS_VI[key];
                if (!text) return;
                
                const { tooltip } = this.dom;
                tooltip.content.innerHTML = `
                    <div class="tooltip-header">
                        <i class="fa-solid fa-language text-emerald-400"></i> Vietnamese Explanation
                    </div>
                    ${text}
                `;
                
                const rect = el.getBoundingClientRect();
                
                tooltip.el.style.top = `${rect.bottom + 8}px`;
                tooltip.el.style.left = `${rect.left}px`;
                tooltip.el.style.opacity = '1';
                tooltip.el.style.transform = 'translateY(0)';
            },

            hideTooltip() {
                const { tooltip } = this.dom;
                tooltip.el.style.opacity = '0';
                tooltip.el.style.transform = 'translateY(4px)';
            },

            analyze() {
                const input = this.dom.input.value.trim();
                if (!input) return alert('Vui lòng nhập yêu cầu!');
                this.state.input = input;

                const strategies = getStrategiesForRole(this.state.roleId);
                const role = ROLES.find(r => r.id === this.state.roleId);

                document.getElementById('strategyRoleLabel').textContent = role.lbl;
                
                this.dom.stratContainer.innerHTML = strategies.map((s, idx) => `
                    <div onclick="App.generate('${idx}')" class="glass-panel p-5 rounded-xl cursor-pointer hover:bg-slate-800/50 transition group border-l-4 border-transparent hover:border-blue-500">
                        <div class="w-10 h-10 rounded bg-slate-800 flex items-center justify-center mb-3 group-hover:scale-110 transition">
                            <i class="fa-solid ${s.icon} text-blue-400"></i>
                        </div>
                        <h4 class="text-white font-bold text-sm mb-1">${s.title}</h4>
                        <p class="text-xs text-slate-400 leading-relaxed mb-2">${s.desc}</p>
                    </div>
                `).join('');

                this.currentStrategies = strategies;
                this.switchView('strategy');
            },

            generate(idx) {
                const strategy = this.currentStrategies[idx];
                const role = ROLES.find(r => r.id === this.state.roleId);
                
                const mockTranslation = `
[Intent Detection]: User wants to implement specific functionality.
[Original VN]: "${this.state.input}"
[Target English Context]: The user requests a solution for the described feature, focusing on ${strategy.title}.
`.trim();

                const finalPrompt = `
You are an expert ${role.lbl} (${role.desc})

CONTEXT STRATEGY: ${strategy.title}
${strategy.promptMod}

USER REQUEST (TRANSLATED CONTEXT):
"""
${mockTranslation}
"""

---
CRITICAL INSTRUCTIONS FOR ONE-SHOT GENERATION:
1.  **NO FOLLOW-UP MEMORY:** Treat this as a single-turn request. Provide the COMPLETE solution now.
2.  **SINGLE FILE MANDATE:** If generating code, output a SINGLE self-contained file (e.g., index.html or PlayerController.cs) using standard markdown code blocks.
3.  **NO HALLUCINATIONS:** Verify libraries exist.
4.  **ROBUSTNESS:** Include error handling and comments explaining *why* you chose this approach.

**STRICT CODE GENERATION RULES:**
1. **NO "LAZY" IMPLEMENTATIONS:** You are strictly FORBIDDEN from generating empty logic blocks such as:
   \`case State.Engaging: // Handled by animation break;\`
   You MUST implement the actual logic, event subscriptions, or robust stubs. Code must be fully functional.
2. **COMPLETE CODE ONLY:** Never use placeholders like \`// ... existing code ...\`. Output the full, runnable file.
3. **VARIABLE PERSISTENCE:** Do NOT rename existing variables unless explicitly asked. Preserving legacy naming is a priority.
4. **VERIFICATION PROTOCOL:** Mentally triple-check the code for syntax and logic errors before outputting.

OUTPUT FORMAT:
- Brief Architectural Decision (Why this approach?)
- The Complete Code Block
- Integration/Usage Notes
`.trim();

                this.dom.output.value = finalPrompt;
                this.switchView('result');
            },

            switchView(name) {
                Object.values(this.dom.views).forEach(el => {
                    el.classList.add('hidden');
                    el.classList.remove('fade-enter-active');
                });
                const target = this.dom.views[name];
                target.classList.remove('hidden');
                void target.offsetWidth; 
                target.classList.add('fade-enter-active');
            }
        };

        window.App = App;
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
